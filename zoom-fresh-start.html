<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoom SDK Fresh Start - FitWithPari</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }

        button {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background 0.3s;
        }

        button:hover {
            background: #ff5252;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
        }

        .video-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .video-tile {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            min-height: 200px;
        }

        .video-tile video {
            width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .participant-name {
            text-align: center;
            font-weight: 600;
            margin-top: 10px;
        }

        .error {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #ff6b6b;
        }

        .success {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid #4caf50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèãÔ∏è Zoom SDK Fresh Start</h1>

        <div class="form-group">
            <label for="sessionName">Session Name</label>
            <input type="text" id="sessionName" value="fresh-fitness-test" placeholder="Enter session name">
        </div>

        <div class="form-group">
            <label for="participantName">Your Name</label>
            <input type="text" id="participantName" value="Coach-Vijeth" placeholder="Enter your name">
        </div>

        <div class="form-group">
            <label for="userRole">Role</label>
            <select id="userRole">
                <option value="host">Coach (Host)</option>
                <option value="participant">Student (Participant)</option>
            </select>
        </div>

        <button id="joinBtn" onclick="joinSession()">Join Fresh Session</button>

        <div id="status" class="status">
            Ready to test fresh Zoom SDK integration...
        </div>

        <div id="videoContainer" class="video-container"></div>
    </div>

    <!-- Fresh Zoom SDK Load -->
    <script src="https://source.zoom.us/2.18.0/lib/vendor/react.min.js"></script>
    <script src="https://source.zoom.us/2.18.0/lib/vendor/react-dom.min.js"></script>
    <script src="https://source.zoom.us/2.18.0/lib/vendor/redux.min.js"></script>
    <script src="https://source.zoom.us/2.18.0/lib/vendor/redux-thunk.min.js"></script>
    <script src="https://source.zoom.us/2.18.0/lib/vendor/lodash.min.js"></script>
    <script src="https://source.zoom.us/videosdk/index.js"></script>

    <script>
        let client = null;
        let stream = null;
        let isJoined = false;

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        async function generateToken() {
            const sessionName = document.getElementById('sessionName').value;
            const role = document.getElementById('userRole').value;
            const userName = document.getElementById('participantName').value;

            updateStatus('Generating token from Lambda...', 'info');

            try {
                const response = await fetch('https://oorxo2zdkjrmmbzdfhaktk5ipa0phjlp.lambda-url.ap-south-1.on.aws', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sessionName: sessionName,
                        role: role,
                        userIdentity: userName,
                        sessionKey: 'fresh-fitness-key'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Token request failed: ${response.status}`);
                }

                const data = await response.json();
                console.log('Token response:', data);

                if (data.signature) {
                    updateStatus('‚úÖ Token generated successfully!', 'success');
                    return data.signature;
                } else {
                    throw new Error('No signature in response');
                }
            } catch (error) {
                updateStatus(`‚ùå Token generation failed: ${error.message}`, 'error');
                throw error;
            }
        }

        async function joinSession() {
            const joinBtn = document.getElementById('joinBtn');
            joinBtn.disabled = true;

            try {
                // Check if Zoom SDK loaded
                if (typeof ZoomVideo === 'undefined') {
                    throw new Error('Zoom SDK failed to load from CDN');
                }

                updateStatus('üöÄ Zoom SDK loaded! Creating client...', 'info');

                // Create client
                client = ZoomVideo.createClient();

                // Set up event listeners
                client.on('connection-change', (payload) => {
                    console.log('Connection change:', payload);
                    if (payload.state === 'Connected') {
                        updateStatus('‚úÖ Connected to Zoom session!', 'success');
                    } else if (payload.state === 'Reconnecting') {
                        updateStatus('üîÑ Reconnecting...', 'info');
                    } else if (payload.state === 'Closed') {
                        updateStatus('‚ùå Connection closed', 'error');
                    }
                });

                client.on('user-added', (payload) => {
                    console.log('User added:', payload);
                    updateStatus(`üë• ${payload[0]?.displayName || 'User'} joined the session`, 'success');
                });

                client.on('user-removed', (payload) => {
                    console.log('User removed:', payload);
                    updateStatus(`üëã User left the session`, 'info');
                });

                client.on('peer-video-state-change', (payload) => {
                    console.log('üìπ Video state changed:', payload);
                    handleVideoStateChange(payload);
                });

                // Generate token
                const token = await generateToken();

                // Join session
                const sessionName = document.getElementById('sessionName').value;
                const userName = document.getElementById('participantName').value;

                updateStatus('üîó Joining Zoom session...', 'info');

                await client.join(sessionName, token, userName, '');

                // Get stream for video operations
                stream = client.getMediaStream();
                isJoined = true;

                updateStatus('üéâ Successfully joined fresh Zoom session!', 'success');

                // Start video if host
                const role = document.getElementById('userRole').value;
                if (role === 'host') {
                    setTimeout(async () => {
                        try {
                            await stream.startVideo();
                            updateStatus('üìπ Video started as host', 'success');
                        } catch (error) {
                            console.error('Failed to start video:', error);
                            updateStatus(`‚ùå Failed to start video: ${error.message}`, 'error');
                        }
                    }, 2000);
                }

            } catch (error) {
                console.error('Join session error:', error);
                updateStatus(`‚ùå Failed to join: ${error.message}`, 'error');
                joinBtn.disabled = false;
            }
        }

        async function handleVideoStateChange(payload) {
            if (!stream) return;

            const { userId, action } = payload;
            const videoContainer = document.getElementById('videoContainer');

            try {
                if (action === 'Start') {
                    updateStatus(`üìπ ${userId} started video`, 'success');

                    // Create video tile
                    const videoTile = document.createElement('div');
                    videoTile.className = 'video-tile';
                    videoTile.id = `video-tile-${userId}`;

                    // Get video element from Zoom
                    const videoElement = await stream.attachVideo(userId, 2); // Quality 2 = 360p

                    videoTile.appendChild(videoElement);

                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'participant-name';
                    nameDiv.textContent = `User ${userId}`;
                    videoTile.appendChild(nameDiv);

                    videoContainer.appendChild(videoTile);

                } else if (action === 'Stop') {
                    updateStatus(`üìπ ${userId} stopped video`, 'info');

                    // Remove video tile
                    const videoTile = document.getElementById(`video-tile-${userId}`);
                    if (videoTile) {
                        videoTile.remove();
                    }
                }
            } catch (error) {
                console.error('Video handling error:', error);
                updateStatus(`‚ùå Video error: ${error.message}`, 'error');
            }
        }

        // Test functions for console
        window.testVideoToggle = async function() {
            if (!stream || !isJoined) {
                console.log('‚ùå Not connected to session');
                return;
            }

            try {
                const isVideoOn = stream.isCapturingVideo();
                if (isVideoOn) {
                    await stream.stopVideo();
                    console.log('üìπ Video stopped');
                } else {
                    await stream.startVideo();
                    console.log('üìπ Video started');
                }
            } catch (error) {
                console.error('Video toggle error:', error);
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('üîÑ Loading fresh Zoom SDK...', 'info');

            // Check SDK loading
            setTimeout(() => {
                if (typeof ZoomVideo !== 'undefined') {
                    updateStatus('‚úÖ Fresh Zoom SDK loaded successfully!', 'success');
                } else {
                    updateStatus('‚ùå Fresh Zoom SDK failed to load', 'error');
                }
            }, 3000);
        });
    </script>
</body>
</html>