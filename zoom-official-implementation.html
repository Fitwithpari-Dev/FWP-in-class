<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Official Zoom Video SDK Implementation - FitWithPari</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .form-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }

        button {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
            transition: background 0.3s;
        }

        button:hover {
            background: #ff5252;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
        }

        .video-section {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-top: 30px;
        }

        .self-video {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            min-height: 250px;
        }

        .participants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .video-tile {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 10px;
            min-height: 150px;
            position: relative;
        }

        .video-tile canvas, .video-tile video {
            width: 100%;
            height: auto;
            border-radius: 5px;
        }

        .participant-name {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
        }

        .controls {
            text-align: center;
            margin: 20px 0;
        }

        .error {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #ff6b6b;
        }

        .success {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid #4caf50;
        }

        .participants-list {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèãÔ∏è Official Zoom SDK Implementation</h1>

        <div class="form-section">
            <h3>Session Configuration</h3>
            <div class="form-group">
                <label for="sessionName">Session Name</label>
                <input type="text" id="sessionName" value="official-fitness-session" placeholder="Enter session name">
            </div>

            <div class="form-group">
                <label for="participantName">Your Name</label>
                <input type="text" id="participantName" value="Coach-Vijeth" placeholder="Enter your name">
            </div>

            <div class="form-group">
                <label for="userRole">Role</label>
                <select id="userRole">
                    <option value="1">Coach (Host)</option>
                    <option value="0">Student (Participant)</option>
                </select>
            </div>

            <button id="joinBtn" onclick="joinSession()">Join Official Session</button>
        </div>

        <div id="status" class="status">
            Ready to join session using official Zoom Video SDK patterns...
        </div>

        <div class="controls" style="display: none;" id="sessionControls">
            <button onclick="toggleVideo()">Toggle Video</button>
            <button onclick="toggleAudio()">Toggle Audio</button>
            <button onclick="leaveSession()">Leave Session</button>
        </div>

        <div class="video-section" style="display: none;" id="videoSection">
            <div class="self-video">
                <h4>Your Video</h4>
                <canvas id="my-self-view-canvas" width="320" height="240"></canvas>
            </div>
            <div>
                <h4>Participants</h4>
                <div class="participants-grid" id="participantsGrid">
                    <!-- Participant videos will be added here -->
                </div>
            </div>
        </div>

        <div class="participants-list" style="display: none;" id="participantsList">
            <h4>Session Participants</h4>
            <div id="participantsInfo"></div>
        </div>
    </div>

    <!-- Zoom Video SDK - Using locally installed package -->
    <script src="./node_modules/@zoom/videosdk/dist/index.umd.js"></script>
    <script>

        let client = null;
        let stream = null;
        let isJoined = false;
        let isVideoOn = false;
        let isAudioOn = false;

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        async function generateToken() {
            const sessionName = document.getElementById('sessionName').value;
            const role = parseInt(document.getElementById('userRole').value);
            const userName = document.getElementById('participantName').value;

            updateStatus('üîê Generating JWT token from fresh Lambda...', 'info');

            try {
                const response = await fetch('https://oorxo2zdkjrmmbzdfhaktk5ipa0phjlp.lambda-url.ap-south-1.on.aws', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sessionName: sessionName,
                        role: role === 1 ? 'host' : 'participant',
                        userIdentity: userName,
                        sessionKey: 'fresh-fitness-key'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Token request failed: ${response.status}`);
                }

                const data = await response.json();
                console.log('‚úÖ Fresh Lambda token response:', data);

                if (data.signature) {
                    updateStatus('‚úÖ Real JWT token generated successfully!', 'success');
                    return data.signature;
                } else {
                    throw new Error('No signature in response');
                }
            } catch (error) {
                updateStatus(`‚ùå Token generation failed: ${error.message}`, 'error');
                throw error;
            }
        }

        async function joinSession() {
            const joinBtn = document.getElementById('joinBtn');
            joinBtn.disabled = true;

            try {
                updateStatus('üöÄ Initializing Zoom Video SDK client...', 'info');

                // Step 1: Create client (Official Pattern)
                client = window.WebVideoSDK.default.createClient();

                // Step 2: Initialize client (Official Pattern)
                await client.init('en-US', 'Global');
                updateStatus('‚úÖ Client initialized successfully!', 'success');

                // Step 3: Set up event listeners (Official Pattern)
                setupEventListeners();

                // Step 4: Generate token
                const token = await generateToken();

                // Step 5: Join session (Official Pattern)
                const sessionName = document.getElementById('sessionName').value;
                const userName = document.getElementById('participantName').value;

                updateStatus('üîó Joining session...', 'info');
                await client.join(sessionName, token, userName);

                // Step 6: Get media stream (Official Pattern)
                stream = client.getMediaStream();
                isJoined = true;

                updateStatus('üéâ Successfully joined session!', 'success');

                // Show controls and video section
                document.getElementById('sessionControls').style.display = 'block';
                document.getElementById('videoSection').style.display = 'block';
                document.getElementById('participantsList').style.display = 'block';

                // Start audio by default
                await startAudio();

                // Update participants list
                updateParticipantsList();

            } catch (error) {
                console.error('‚ùå Join session error:', error);
                updateStatus(`‚ùå Failed to join: ${error.message}`, 'error');
                joinBtn.disabled = false;
            }
        }

        function setupEventListeners() {
            // Connection state changes
            client.on('connection-change', (payload) => {
                console.log('üîó Connection change:', payload);
                if (payload.state === 'Connected') {
                    updateStatus('‚úÖ Connected to session!', 'success');
                } else if (payload.state === 'Reconnecting') {
                    updateStatus('üîÑ Reconnecting...', 'info');
                } else if (payload.state === 'Closed') {
                    updateStatus('‚ùå Connection closed', 'error');
                    resetUI();
                }
            });

            // User added/removed
            client.on('user-added', (payload) => {
                console.log('üë• User added:', payload);
                updateParticipantsList();
                payload.forEach(user => {
                    updateStatus(`üëã ${user.displayName} joined`, 'success');
                });
            });

            client.on('user-removed', (payload) => {
                console.log('üëã User removed:', payload);
                updateParticipantsList();
                payload.forEach(user => {
                    updateStatus(`üëã ${user.displayName} left`, 'info');
                    removeParticipantVideo(user.userId);
                });
            });

            // Video state changes (Official Pattern)
            client.on('peer-video-state-change', (payload) => {
                console.log('üìπ Peer video state change:', payload);
                handlePeerVideoStateChange(payload);
            });

            // Audio state changes
            client.on('peer-audio-state-change', (payload) => {
                console.log('üîä Peer audio state change:', payload);
            });

            // Active speaker
            client.on('active-speaker', (payload) => {
                console.log('üó£Ô∏è Active speaker:', payload);
            });
        }

        async function handlePeerVideoStateChange(payload) {
            const { userId, action } = payload;
            const participantsGrid = document.getElementById('participantsGrid');

            try {
                if (action === 'Start') {
                    updateStatus(`üìπ ${userId} started video`, 'success');

                    // Create video tile
                    const videoTile = document.createElement('div');
                    videoTile.className = 'video-tile';
                    videoTile.id = `video-tile-${userId}`;

                    // Create canvas for video rendering (Official Pattern)
                    const canvas = document.createElement('canvas');
                    canvas.width = 320;
                    canvas.height = 240;
                    canvas.id = `canvas-${userId}`;

                    videoTile.appendChild(canvas);

                    // Add participant name
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'participant-name';
                    const userInfo = client.getAllUser().find(u => u.userId === userId);
                    nameDiv.textContent = userInfo?.displayName || `User ${userId}`;
                    videoTile.appendChild(nameDiv);

                    participantsGrid.appendChild(videoTile);

                    // Start rendering video (Official Pattern)
                    await stream.renderVideo(canvas, userId, 320, 240, 0, 0, 2);

                } else if (action === 'Stop') {
                    updateStatus(`üìπ ${userId} stopped video`, 'info');
                    removeParticipantVideo(userId);

                    // Stop rendering video (Official Pattern)
                    await stream.stopRenderVideo(canvas, userId);
                }
            } catch (error) {
                console.error('‚ùå Video handling error:', error);
                updateStatus(`‚ùå Video error: ${error.message}`, 'error');
            }
        }

        function removeParticipantVideo(userId) {
            const videoTile = document.getElementById(`video-tile-${userId}`);
            if (videoTile) {
                videoTile.remove();
            }
        }

        async function toggleVideo() {
            if (!stream || !isJoined) return;

            try {
                if (isVideoOn) {
                    await stream.stopVideo();
                    updateStatus('üìπ Video stopped', 'info');
                } else {
                    await stream.startVideo();
                    updateStatus('üìπ Video started', 'success');

                    // Render self video (Official Pattern)
                    const selfCanvas = document.getElementById('my-self-view-canvas');
                    const currentUser = client.getCurrentUserInfo();
                    await stream.renderVideo(selfCanvas, currentUser.userId, 320, 240, 0, 0, 2);
                }
                isVideoOn = !isVideoOn;
            } catch (error) {
                console.error('‚ùå Video toggle error:', error);
                updateStatus(`‚ùå Video toggle failed: ${error.message}`, 'error');
            }
        }

        async function toggleAudio() {
            if (!isJoined) return;

            try {
                if (isAudioOn) {
                    await client.stopAudio();
                    updateStatus('üîá Audio muted', 'info');
                } else {
                    await client.startAudio();
                    updateStatus('üîä Audio unmuted', 'success');
                }
                isAudioOn = !isAudioOn;
            } catch (error) {
                console.error('‚ùå Audio toggle error:', error);
                updateStatus(`‚ùå Audio toggle failed: ${error.message}`, 'error');
            }
        }

        async function startAudio() {
            try {
                await client.startAudio();
                isAudioOn = true;
                updateStatus('üîä Audio started', 'success');
            } catch (error) {
                console.error('‚ùå Audio start error:', error);
                updateStatus(`‚ùå Audio start failed: ${error.message}`, 'error');
            }
        }

        async function leaveSession() {
            if (!isJoined) return;

            try {
                await client.leave();
                updateStatus('üëã Left session', 'info');
                resetUI();
            } catch (error) {
                console.error('‚ùå Leave session error:', error);
                updateStatus(`‚ùå Leave failed: ${error.message}`, 'error');
            }
        }

        function updateParticipantsList() {
            if (!client) return;

            const participantsInfo = document.getElementById('participantsInfo');
            const users = client.getAllUser();
            const currentUser = client.getCurrentUserInfo();

            let html = `<strong>Total Participants: ${users.length + 1}</strong><br><br>`;

            // Add current user
            html += `<div>üéØ ${currentUser.displayName} (You) - ID: ${currentUser.userId}</div>`;

            // Add other users
            users.forEach(user => {
                html += `<div>üë§ ${user.displayName} - ID: ${user.userId}</div>`;
            });

            participantsInfo.innerHTML = html;
        }

        function resetUI() {
            isJoined = false;
            isVideoOn = false;
            isAudioOn = false;

            document.getElementById('joinBtn').disabled = false;
            document.getElementById('sessionControls').style.display = 'none';
            document.getElementById('videoSection').style.display = 'none';
            document.getElementById('participantsList').style.display = 'none';
            document.getElementById('participantsGrid').innerHTML = '';
            document.getElementById('participantsInfo').innerHTML = '';

            // Clear self video canvas
            const selfCanvas = document.getElementById('my-self-view-canvas');
            const ctx = selfCanvas.getContext('2d');
            ctx.clearRect(0, 0, selfCanvas.width, selfCanvas.height);
        }

        // Global functions for console testing
        window.toggleVideo = toggleVideo;
        window.toggleAudio = toggleAudio;
        window.leaveSession = leaveSession;
        window.joinSession = joinSession;

        // Initialize and debug what's available
        console.log('window.WebVideoSDK:', window.WebVideoSDK);
        console.log('window.ZoomVideo:', window.ZoomVideo);
        console.log('All window properties with "Video" or "Zoom":', Object.keys(window).filter(key => key.includes('Video') || key.includes('Zoom')));
        updateStatus('üìã Official Zoom Video SDK implementation ready', 'success');

    </script>
</body>
</html>